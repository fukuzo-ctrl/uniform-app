<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        :root { --sidebar-w: 350px; --accent: #00738D; }
        body { margin: 0; background: #e0e0e0; font-family: sans-serif; overflow: hidden; height: 100vh; }
        .screen { position: fixed; top:0; left:0; width:100%; height:100%; display:none; flex-direction: column; align-items: center; justify-content: center; }
        
        #start-screen { display: flex; background: var(--accent); color: #fff; z-index: 1000; }
        .sport-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 90%; max-width: 600px; }
        .sport-card { background: #fff; color: #333; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .handover-box { margin-top: 30px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; width: 80%; max-width: 400px; }
        .handover-input { width: 100%; padding: 12px; font-size: 18px; border-radius: 5px; border: none; text-align: center; font-family: monospace; letter-spacing: 5px; text-transform: uppercase; outline: none; }

        .preview { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #ffffff; position: relative; overflow: auto; }
        #svg-canvas { display: flex; align-items: center; justify-content: center; position: relative; width: 600px; height: 600px; background-image: url("https://drive.google.com/uc?export=view&id=1X1p9P-9uR-u_K9yX9P-9uR-u_K9yX9P"); background-size: contain; background-repeat: no-repeat; background-position: center; }
        svg { width: 100% !important; height: 100% !important; mix-blend-mode: multiply; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); }
        
        .sidebar { width: var(--sidebar-w); background: #fff; padding: 15px; border-right: 1px solid #ccc; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; box-sizing: border-box; }
        .group { background: #f9f9f9; padding: 10px; border: 1px solid #eee; border-radius: 5px; }
        .label-row { display: grid; grid-template-columns: 85px 1fr 45px; align-items: center; gap: 10px; font-size: 11px; font-weight: bold; margin-bottom: 6px; }
        .color-name-display { text-align: right; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .swatch { width: 45px; height: 25px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        
        .type-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
        .type-btn { font-size: 10px; padding: 6px; background: #ddd; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .type-btn.active { background: var(--accent); color: #fff; }

        .popover { position: fixed; left: 360px; top: 50%; transform: translateY(-50%); width: 240px; background: #fff; border: 1px solid #ccc; box-shadow: 0 5px 25px rgba(0,0,0,0.3); padding: 12px; display: none; z-index: 1000; border-radius: 10px; }
        #hover-color-name { height: 20px; text-align: center; margin-bottom: 10px; font-weight: bold; color: var(--accent); border-bottom: 1px solid #eee; font-size: 13px; }
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
        .chip { width: 100%; aspect-ratio: 1; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
        
        .btn-save { background: var(--accent); color: #fff; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }
        
        #admin_panel { display: none; }
        .admin-item { font-size: 10px; color: #666; margin-top: 5px; }
        input[type="range"] { width: 100%; margin: 2px 0; cursor: pointer; }
        #custom_svg_input { width: 100%; height: 60px; font-size: 9px; margin-top: 5px; font-family: monospace; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body onclick="hideAllPops()">

    <div id="start-screen" class="screen">
        <h1 style="letter-spacing: 2px; margin-bottom: 25px;">UNIFORM BUILDER</h1>
        <div class="sport-grid">
            <div class="sport-card" onclick="openCatalog('ã‚µãƒƒã‚«ãƒ¼')">âš½ ã‚µãƒƒã‚«ãƒ¼</div>
            <div class="sport-card" onclick="openCatalog('ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«')">ğŸ ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«</div>
            <div class="sport-card" onclick="openCatalog('é‡çƒ')">âš¾ é‡çƒ</div>
            <div class="sport-card" onclick="openCatalog('ãƒã‚¹ã‚±ãƒƒãƒˆ')">ğŸ€ ãƒã‚¹ã‚±ãƒƒãƒˆ</div>
        </div>

        <div class="handover-box">
            <div style="margin-bottom: 10px; font-size: 12px; font-weight: bold;">å°‚ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å—ã‘å–ã‚‹</div>
            <input type="text" id="handover_key" class="handover-input" placeholder="CODE" maxlength="5">
            <button onclick="receiveHandover()" style="margin-top: 10px; width: 100%; padding: 10px; background: #fff; color: var(--accent); border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¡¨ç¤º</button>
        </div>

        <div onclick="enableAdminModeInside()" style="position: absolute; bottom: 20px; right: 20px; opacity: 0.5; cursor: pointer; font-size: 11px;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
    </div>

    <div id="catalog-screen" class="screen" style="background:#f0f0f2; align-items: center; justify-content: flex-start; padding-top:20px;">
        <button onclick="goBackToStart()" style="margin-bottom:20px; padding:10px 20px; cursor:pointer;">â† æˆ»ã‚‹</button>
        <div id="gallery-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:20px; width:90%;"></div>
    </div>

    <div id="main-app" class="screen" style="flex-direction:row; display:none;">
        <aside class="sidebar" onclick="event.stopPropagation()">
            <button onclick="goBackToCatalog()" id="btn_back_catalog" style="margin-bottom:10px;">â† ã‚«ã‚¿ãƒ­ã‚°ã¸</button>
            
            <div id="admin_panel" class="group">
                <div style="color:red; font-weight:bold; font-size:11px; margin-bottom:8px;">â˜…ç®¡ç†è€…è¨­å®š</div>
                <button onclick="issueHandover()" style="background: #f0ad4e; color:white; border:none; padding:8px; width:100%; border-radius:5px; font-weight:bold; margin-bottom:10px; cursor:pointer;">é¡§å®¢ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚­ãƒ¼ã‚’ç™ºè¡Œ</button>
                <div id="key_display" style="display:none; background:#fff; border:1px solid #f0ad4e; color:red; padding:10px; text-align:center; font-weight:bold; font-size:16px; margin-bottom:10px;">ã‚­ãƒ¼: <span id="v_handover_key"></span></div>
                <div class="admin-item" style="color:blue;">â–¼åˆ¥æ³¨SVGã‚³ãƒ¼ãƒ‰ç›´æ¥è²¼ã‚Šä»˜ã‘</div>
                <textarea id="custom_svg_input" placeholder="<svg ...>ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
                <button onclick="applyCustomSVG()" style="background:blue; color:white; border:none; width:100%; font-size:10px; padding:5px; margin-top:3px; cursor:pointer;">SVGã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ </button>
                <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                <div class="admin-item">å…¨ä½“Scale: <span id="v_sc"></span>%</div>
                <input type="range" id="i_sc" min="50" max="200" oninput="apply()">
                <input type="range" id="i_ns" min="10" max="300" oninput="apply()"><input type="range" id="i_nx" min="0" max="676" oninput="apply()"><input type="range" id="i_ny" min="0" max="800" oninput="apply()">
                <input type="range" id="i_ms" min="5" max="150" oninput="apply()"><input type="range" id="i_mx" min="0" max="676" oninput="apply()"><input type="range" id="i_my" min="0" max="800" oninput="apply()"><input type="range" id="i_mw" min="50" max="600" oninput="apply()">
                <input type="text" id="i_bg" placeholder="èƒŒæ™¯ç”»åƒURL" style="width:100%; font-size:10px; margin-top:5px;" oninput="apply()">
                <button class="btn-save" onclick="saveSettings()" style="background:#d9534f; margin-top:10px;">è¨­å®šã‚’ä¿å­˜</button>
                <div id="admin-palette-editor" style="max-height: 100px; overflow-y: auto; background: #fff; margin-top:10px; border:1px solid #ccc;"></div>
                <button class="btn-save" onclick="saveMasterPalette()" style="background:blue; margin-top:5px;">è‰²ç‰ãƒã‚¹ã‚¿ã‚’ä¿å­˜</button>
            </div>

            <div class="group">
                <label style="font-size:10px; font-weight:bold;">å•†å“ç¨®åˆ¥</label>
                <div class="type-selector">
                    <button id="type_shirt" class="type-btn active" onclick="changeItemType('ã‚·ãƒ£ãƒ„ã®ã¿')">ã‚·ãƒ£ãƒ„ã®ã¿</button>
                    <button id="type_pants" class="type-btn" onclick="changeItemType('ãƒ‘ãƒ³ãƒ„ã®ã¿')">ãƒ‘ãƒ³ãƒ„ã®ã¿</button>
                    <button id="type_set" class="type-btn" onclick="changeItemType('ã‚»ãƒƒãƒˆ')">ã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div class="group">
                <label style="font-size:10px; font-weight:bold;">ãƒ‡ã‚¶ã‚¤ãƒ³é¸æŠ</label>
                <select id="design_select" onchange="updateCollarOptions()" style="width:100%; padding:5px;"></select>
                <select id="collar_select" onchange="loadVariant()" style="margin-top:5px; width:100%; padding:5px;"></select>
            </div>

            <div class="group">
                <label style="font-size:10px; font-weight:bold;">ã‚«ãƒ©ãƒ¼è¨­å®š (38è‰²)</label>
                <div class="label-row"><span>èº«é ƒ 1</span> <span id="txt_c0" class="color-name-display"></span> <div class="swatch" id="sw_c0" onclick="togglePop('c0')"></div></div>
                <div class="label-row"><span>èº«é ƒ 2</span> <span id="txt_c1" class="color-name-display"></span> <div class="swatch" id="sw_c1" onclick="togglePop('c1')"></div></div>
                <div class="label-row"><span>èº«é ƒ 3</span> <span id="txt_c4" class="color-name-display"></span> <div class="swatch" id="sw_c4" onclick="togglePop('c4')"></div></div>
                <div class="label-row"><span>å³è¢–</span> <span id="txt_c3" class="color-name-display"></span> <div class="swatch" id="sw_c3" onclick="togglePop('c3')"></div></div>
                <div class="label-row"><span>å·¦è¢–</span> <span id="txt_c6" class="color-name-display"></span> <div class="swatch" id="sw_c6" onclick="togglePop('c6')"></div></div>
                <div class="label-row"><span>è¥Ÿãƒ»ãƒ‘ãƒ³ãƒ„</span> <span id="txt_c5" class="color-name-display"></span> <div class="swatch" id="sw_c5" onclick="togglePop('c5')"></div></div>
            </div>

            <div class="group">
                <label style="font-size:10px; font-weight:bold;">ç•ªå·ã¨åå‰ã®ã‚«ã‚¹ã‚¿ãƒ </label>
                <div class="label-row"><span>ç•ªå·ã®è‰²</span> <span id="txt_nc" class="color-name-display"></span> <div class="swatch" id="sw_nc" onclick="togglePop('nc')"></div></div>
                <div class="label-row"><span>åå‰ã®è‰²</span> <span id="txt_mc" class="color-name-display"></span> <div class="swatch" id="sw_mc" onclick="togglePop('mc')"></div></div>
                <input type="text" id="v_num" placeholder="ç•ªå·" oninput="apply()" style="width:100%; padding:8px; box-sizing:border-box;">
                <input type="text" id="v_name" placeholder="åå‰" oninput="apply()" style="width:100%; margin-top:5px; padding:8px; box-sizing:border-box;">
            </div>

            <button class="btn-save" onclick="saveOrder()">æ³¨æ–‡å†…å®¹ã‚’é€ä¿¡</button>
        </aside>

        <main class="preview" id="preview_area"><div id="svg-canvas"></div></main>
        <div id="color-popover" class="popover" onclick="event.stopPropagation()"><div id="hover-color-name">è‰²å</div><div id="color-grid" class="color-grid"></div></div>
    </div>

    <script>
        let COLORS = [{n:"ãƒ–ãƒ©ãƒƒã‚¯",c:"#000000"},{n:"ãƒ›ãƒ¯ã‚¤ãƒˆ",c:"#ffffff"}];
        let curColors = { c0:{c:"#41b6e6",n:"ã‚µãƒƒã‚¯ã‚¹"}, c1:{c:"#e4002b",n:"ãƒ¬ãƒƒãƒ‰"}, c4:{c:"#ffffff",n:"ãƒ›ãƒ¯ã‚¤ãƒˆ"}, c3:{c:"#b7d433",n:"ãƒ©ã‚¤ãƒ "}, c6:{c:"#b7d433",n:"ãƒ©ã‚¤ãƒ "}, c5:{c:"#e4002b",n:"ãƒ¬ãƒƒãƒ‰"}, nc:{c:"#000000",n:"ãƒ–ãƒ©ãƒƒã‚¯"}, mc:{c:"#000000",n:"ãƒ–ãƒ©ãƒƒã‚¯"} };
        let designLibrary = {}, savedSettings = {}, activePart = null, currentSport = "", currentType = "ã‚·ãƒ£ãƒ„ã®ã¿", isAdminActive = false;

        window.onload = () => {
            google.script.run.withSuccessHandler(p => { if(p) COLORS = p; initColorPicker(); updateSwatches(); }).getColorPalette();
            google.script.run.withSuccessHandler(s => { savedSettings = s; }).getSportSettings();
        };

        function initColorPicker() {
            const grid = document.getElementById('color-grid'), nameDisp = document.getElementById('hover-color-name'), adminEditor = document.getElementById('admin-palette-editor');
            grid.innerHTML = ''; adminEditor.innerHTML = '';
            COLORS.forEach((item, i) => {
                const chip = document.createElement('div'); chip.className = 'chip'; chip.style.backgroundColor = item.c;
                chip.onmouseover = () => { nameDisp.textContent = item.n; nameDisp.style.color = (item.c === '#ffffff' ? '#333' : item.c); };
                chip.onclick = () => selectColor(item.c, item.n); grid.appendChild(chip);
                const row = document.createElement('div'); row.style.display="flex"; row.innerHTML = `<input type="text" id="pal_n_${i}" value="${item.n}" style="flex:1; font-size:10px;"> <input type="color" id="pal_c_${i}" value="${item.c}">`;
                adminEditor.appendChild(row);
            });
        }

        function applyCustomSVG() {
            const code = document.getElementById('custom_svg_input').value.trim();
            if(!code) { alert("SVGã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return; }
            document.getElementById('svg-canvas').innerHTML = code;
            apply();
            alert("SVGã‚’åæ˜ ã—ã¾ã—ãŸã€‚ä½ç½®ã‚„è‰²ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚");
        }

        function receiveHandover() {
            const key = document.getElementById('handover_key').value.trim();
            if(!key) { alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            google.script.run.withSuccessHandler(data => {
                if(!data) { alert("æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
                currentSport = data.sportName;
                document.getElementById('design_select').innerHTML = `<option value="${data.designName}">${data.designName}</option>`;
                document.getElementById('collar_select').innerHTML = `<option value="0">${data.collar}</option>`;
                document.getElementById('svg-canvas').innerHTML = data.svg;
                const c = data.config;
                curColors = c.colors;
                document.getElementById('i_sc').value = c.scale;
                document.getElementById('i_ns').value = c.n_size; document.getElementById('i_nx').value = c.n_x; document.getElementById('i_ny').value = c.n_y;
                document.getElementById('i_ms').value = c.m_size; document.getElementById('i_mx').value = c.m_x; document.getElementById('i_my').value = c.m_y;
                document.getElementById('i_mw').value = c.m_w;
                document.getElementById('v_num').value = c.num_text;
                document.getElementById('v_name').value = c.name_text;
                currentType = c.item_type;
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('btn_back_catalog').style.display = 'none'; 
                updateSwatches();
                apply();
            }).loadHandoverDesign(key);
        }

        function issueHandover() {
            const data = {
                sportName: currentSport || "åˆ¥æ³¨",
                designName: document.getElementById('design_select').value || "ç‰¹åˆ¥ãƒ‡ã‚¶ã‚¤ãƒ³",
                collar: document.getElementById('collar_select').options.length > 0 ? document.getElementById('collar_select').options[document.getElementById('collar_select').selectedIndex].text : "åŸºæœ¬",
                svg: document.getElementById('svg-canvas').innerHTML,
                config: {
                    colors: curColors, scale: document.getElementById('i_sc').value,
                    n_size: document.getElementById('i_ns').value, n_x: document.getElementById('i_nx').value, n_y: document.getElementById('i_ny').value,
                    m_size: document.getElementById('i_ms').value, m_x: document.getElementById('i_mx').value, m_y: document.getElementById('i_my').value,
                    m_w: document.getElementById('i_mw').value, num_text: document.getElementById('v_num').value, name_text: document.getElementById('v_name').value,
                    item_type: currentType
                }
            };
            google.script.run.withSuccessHandler(key => {
                document.getElementById('key_display').style.display = 'block';
                document.getElementById('v_handover_key').textContent = key;
                alert("ãƒ‡ã‚¶ã‚¤ãƒ³ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¾ã—ãŸ: " + key);
            }).saveHandoverDesign(data);
        }

        function changeItemType(type) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            if(type==='ã‚·ãƒ£ãƒ„ã®ã¿') document.getElementById('type_shirt').classList.add('active');
            if(type==='ãƒ‘ãƒ³ãƒ„ã®ã¿') document.getElementById('type_pants').classList.add('active');
            if(type==='ã‚»ãƒƒãƒˆ') document.getElementById('type_set').classList.add('active');
            apply();
        }

        function enableAdminModeInside() {
            if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›") === "admin") {
                isAdminActive = true;
                document.getElementById('admin_panel').style.display = 'block';
                document.getElementById('v_num').value = "";
                document.getElementById('v_name').value = "";
                alert("ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ON");
            }
        }

        function togglePop(p) { activePart = p; document.getElementById('color-popover').style.display = 'block'; }
        function hideAllPops() { document.getElementById('color-popover').style.display = 'none'; }
        function selectColor(c, n) { curColors[activePart] = {c:c, n:n}; updateSwatches(); apply(); hideAllPops(); }
        function updateSwatches() { for(let id in curColors) { const sw=document.getElementById("sw_"+id), tx=document.getElementById("txt_"+id); if(sw) sw.style.backgroundColor = curColors[id].c; if(tx) tx.textContent = curColors[id].n; } }

        function openCatalog(s) {
            currentSport = s;
            google.script.run.withSuccessHandler(lib => {
                designLibrary = lib;
                const grid = document.getElementById('gallery-grid'); grid.innerHTML = '';
                const sel = document.getElementById('design_select'); sel.innerHTML = '';
                for(let name in lib) {
                    let card = document.createElement('div'); card.className = 'sport-card'; card.onclick = () => startSim(name);
                    card.innerHTML = `<div style="height:100px; overflow:hidden;">${lib[name].variants[0].svg}</div><p>${name}</p>`;
                    grid.appendChild(card);
                    let opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
                }
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('catalog-screen').style.display = 'flex';
            }).getDesignLibraryBySport(s);
        }

        function startSim(name) {
            document.getElementById('design_select').value = name;
            document.getElementById('catalog-screen').style.display='none';
            document.getElementById('main-app').style.display='flex';
            const s = savedSettings[currentSport] || { scale:100, bgUrl:"", n_size:100, n_x:338, n_y:150, m_size:40, m_x:338, m_y:100, m_w:250 };
            document.getElementById('i_sc').value = s.scale; document.getElementById('i_ns').value = s.n_size; document.getElementById('i_nx').value = s.n_x; document.getElementById('i_ny').value = s.n_y;
            document.getElementById('i_ms').value = s.m_size; document.getElementById('i_mx').value = s.m_x; document.getElementById('i_my').value = s.m_y; document.getElementById('i_mw').value = s.m_w;
            if(!isAdminActive) { document.getElementById('v_num').value = "10"; document.getElementById('v_name').value = "TASTO"; }
            updateCollarOptions();
        }

        function updateCollarOptions() {
            const name = document.getElementById('design_select').value;
            const sel = document.getElementById('collar_select'); sel.innerHTML = '';
            if(designLibrary[name]) { designLibrary[name].variants.forEach((v, i) => { let opt = document.createElement('option'); opt.value = i; opt.textContent = v.collar; sel.appendChild(opt); }); }
            loadVariant();
        }

        function loadVariant() {
            const name = document.getElementById('design_select').value, idx = document.getElementById('collar_select').value;
            if(designLibrary[name] && designLibrary[name].variants[idx]) { document.getElementById('svg-canvas').innerHTML = designLibrary[name].variants[idx].svg; }
            apply();
        }

        function apply() {
            const canvas = document.getElementById('svg-canvas'), svg = canvas.querySelector('svg');
            if(!svg) return;
            const shirtParts = svg.querySelectorAll('[id^="shirt"]'), pantsParts = svg.querySelectorAll('[id^="pants"]');
            if(currentType === 'ã‚·ãƒ£ãƒ„ã®ã¿') { shirtParts.forEach(p=>p.style.display=''); pantsParts.forEach(p=>p.style.display='none'); }
            else if(currentType === 'ãƒ‘ãƒ³ãƒ„ã®ã¿') { shirtParts.forEach(p=>p.style.display='none'); pantsParts.forEach(p=>p.style.display=''); }
            else { shirtParts.forEach(p=>p.style.display=''); pantsParts.forEach(p=>p.style.display=''); }

            const sc = document.getElementById('i_sc').value;
            document.getElementById('v_sc').textContent = sc;
            canvas.style.width = (6 * sc) + "px"; canvas.style.height = (6 * sc) + "px";
            document.getElementById('preview_area').style.backgroundImage = document.getElementById('i_bg').value ? `url("${document.getElementById('i_bg').value}")` : '';
            
            svg.style.setProperty('--c0', curColors.c0.c); svg.style.setProperty('--c1', curColors.c1.c); svg.style.setProperty('--c4', curColors.c4.c); 
            svg.style.setProperty('--c3', curColors.c3.c); svg.style.setProperty('--c6', curColors.c6.c); svg.style.setProperty('--c5', curColors.c5.c);
            
            if(!svg.getElementById('svg_num')) { svg.insertAdjacentHTML('beforeend', `<g style="pointer-events:none;"><text id="svg_num" text-anchor="middle" font-family="Impact"></text><text id="svg_name" text-anchor="middle" font-family="Impact"></text></g>`); }
            const n = svg.getElementById('svg_num'), m = svg.getElementById('svg_name');
            n.textContent = document.getElementById('v_num').value;
            n.setAttribute('fill', curColors.nc.c); n.style.setProperty('fill', curColors.nc.c, 'important');
            n.setAttribute('font-size', document.getElementById('i_ns').value); n.setAttribute('x', document.getElementById('i_nx').value); n.setAttribute('y', document.getElementById('i_ny').value);
            
            m.textContent = (document.getElementById('v_name').value).toUpperCase();
            m.setAttribute('fill', curColors.mc.c); m.style.setProperty('fill', curColors.mc.c, 'important'); 
            m.setAttribute('font-size', document.getElementById('i_ms').value); m.setAttribute('x', document.getElementById('i_mx').value); m.setAttribute('y', document.getElementById('i_my').value);
            
            const mw = document.getElementById('i_mw').value;
            m.removeAttribute('textLength'); m.removeAttribute('lengthAdjust');
            if(m.getComputedTextLength() > mw) { m.setAttribute('textLength', mw); m.setAttribute('lengthAdjust', 'spacingAndGlyphs'); }
        }

        function saveSettings() {
            const data = { sportName: currentSport, scale: document.getElementById('i_sc').value, bgUrl: document.getElementById('i_bg').value, n_size: document.getElementById('i_ns').value, n_x: document.getElementById('i_nx').value, n_y: document.getElementById('i_ny').value, m_size: document.getElementById('i_ms').value, m_x: document.getElementById('i_mx').value, m_y: document.getElementById('i_my').value, m_w: document.getElementById('i_mw').value };
            google.script.run.withSuccessHandler(res => alert(res)).saveSportSettings(data);
        }
        function saveMasterPalette() { let newPalette = []; COLORS.forEach((_, i) => { newPalette.push({ n: document.getElementById(`pal_n_${i}`).value, c: document.getElementById(`pal_c_${i}`).value }); }); google.script.run.withSuccessHandler(res => { alert(res); location.reload(); }).saveColorPalette(newPalette); }
        function saveOrder() {
            const name = document.getElementById('design_select').value, idx = document.getElementById('collar_select').value, v = designLibrary[name] ? designLibrary[name].variants[idx] : {id:"custom", collar:"custom"};
            const data = { itemType: currentType, designId: v.id, designName: name || "ç‰¹åˆ¥åˆ¥æ³¨", sportType: currentSport || "åˆ¥æ³¨", collarType: v.collar, number: document.getElementById('v_num').value, nameText: document.getElementById('v_name').value, colorBody1: curColors.c0.n, colorBody2: curColors.c1.n, colorBody3: curColors.c4.n, colorSleeveR: curColors.c3.n, colorSleeveL: curColors.c6.n, colorCollar: curColors.c5.n, colorNum: curColors.nc.n, colorName: curColors.mc.n };
            google.script.run.withSuccessHandler(() => alert("é€ä¿¡å®Œäº†")).saveOrder(data);
        }
        function goBackToStart() { document.getElementById('catalog-screen').style.display='none'; document.getElementById('start-screen').style.display='flex'; }
        function goBackToCatalog() { document.getElementById('main-app').style.display='none'; document.getElementById('catalog-screen').style.display='flex'; }
    </script>
</body>
</html>