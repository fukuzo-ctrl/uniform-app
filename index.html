<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        :root { --sidebar-w: 350px; --accent: #00738D; }
        body { margin: 0; background: #e0e0e0; font-family: sans-serif; overflow: hidden; height: 100vh; }
        .screen { position: fixed; top:0; left:0; width:100%; height:100%; display:none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ - ã‚¢ã‚¤ã‚³ãƒ³å¾©æ´» */
        #start-screen { display: flex; background: var(--accent); color: #fff; z-index: 1000; }
        .sport-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 90%; max-width: 600px; }
        .sport-card { background: #fff; color: #333; padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ - æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ã«ä¿®æ­£ */
        .preview { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #bcbcbc 0%, #8c8c8c 100%); position: relative; overflow: auto; }
        
        /* 3Dç™½ã„ã‚¸ãƒ£ãƒ¼ã‚¸åœŸå° */
        #svg-canvas { 
            display: flex; align-items: center; justify-content: center; position: relative; width: 600px; height: 600px;
            background-image: url("https://drive.google.com/uc?export=view&id=1X1p9P-9uR-u_K9yX9P-9uR-u_K9yX9P"); 
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        svg { width: 100% !important; height: 100% !important; mix-blend-mode: multiply; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar { width: var(--sidebar-w); background: #fff; padding: 15px; border-right: 1px solid #ccc; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .group { background: #f9f9f9; padding: 10px; border: 1px solid #eee; border-radius: 5px; }
        .label-row { display: flex; justify-content: space-between; font-size: 11px; font-weight: bold; align-items: center; margin-bottom: 4px; }
        .swatch { width: 45px; height: 25px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        
        /* ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .popover { position: fixed; left: 360px; top: 50%; transform: translateY(-50%); width: 220px; background: #fff; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 10px; display: none; z-index: 1000; border-radius: 8px; }
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
        .chip { width: 100%; aspect-ratio: 1; border-radius: 2px; cursor: pointer; border: 1px solid #eee; }
        
        .btn-save { background: var(--accent); color: #fff; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ç”¨ */
        #admin_indicator { color: red; font-size: 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body onclick="hideAllPops()">

    <div id="start-screen" class="screen">
        <h1>UNIFORM BUILDER PRO</h1>
        <div class="sport-grid">
            <div class="sport-card" onclick="openCatalog('ã‚µãƒƒã‚«ãƒ¼')">âš½ ã‚µãƒƒã‚«ãƒ¼</div>
            <div class="sport-card" onclick="openCatalog('ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«')">ğŸ ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«</div>
            <div class="sport-card" onclick="openCatalog('é‡çƒ')">âš¾ é‡çƒ</div>
            <div class="sport-card" onclick="openCatalog('ãƒã‚¹ã‚±ãƒƒãƒˆ')">ğŸ€ ãƒã‚¹ã‚±ãƒƒãƒˆ</div>
        </div>
        <div onclick="enableAdminMode()" style="position: absolute; bottom: 20px; right: 20px; opacity: 0.5; cursor: pointer; font-size: 12px;">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</div>
    </div>

    <div id="catalog-screen" class="screen" style="background:#f0f0f2;">
        <button onclick="goBackToStart()" style="margin:20px; padding:10px;">â† æˆ»ã‚‹</button>
        <div id="gallery-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:20px; width:90%;"></div>
    </div>

    <div id="main-app" class="screen" style="flex-direction:row; display:none;">
        <aside class="sidebar" onclick="event.stopPropagation()">
            <button onclick="goBackToCatalog()">â† ã‚«ã‚¿ãƒ­ã‚°ã¸</button>
            <div id="admin_indicator" style="display:none;">ADMIN MODE ACTIVE</div>
            
            <div class="group">
                <label style="font-size:10px; font-weight:bold;">ãƒ‡ã‚¶ã‚¤ãƒ³</label>
                <select id="design_select" onchange="updateCollarOptions()"></select>
                <select id="collar_select" onchange="loadVariant()" style="margin-top:5px;"></select>
            </div>

            <div class="group">
                <label style="font-size:10px; font-weight:bold;">ã‚«ãƒ©ãƒ¼è¨­å®š (38è‰²)</label>
                <div class="label-row">èº«é ƒ <span id="txt_c0" style="color:var(--accent);"></span> <div class="swatch" id="sw_c0" onclick="togglePop('c0')"></div></div>
                <div class="label-row">è¢– <span id="txt_c3" style="color:var(--accent);"></span> <div class="swatch" id="sw_c3" onclick="togglePop('c3')"></div></div>
                <div class="label-row">è¥Ÿ <span id="txt_c5" style="color:var(--accent);"></span> <div class="swatch" id="sw_c5" onclick="togglePop('c5')"></div></div>
            </div>

            <div class="group">
                <label style="font-size:10px; font-weight:bold;">æ–‡å­—/ç•ªå·</label>
                <div class="label-row">æ–‡å­—è‰² <span id="txt_nc" style="color:var(--accent);"></span> <div class="swatch" id="sw_nc" onclick="togglePop('nc')"></div></div>
                <input type="text" id="v_num" placeholder="ç•ªå·" oninput="apply()">
                <input type="text" id="v_name" placeholder="åå‰" oninput="apply()">
            </div>

            <button class="btn-save" onclick="saveOrder()">æ³¨æ–‡ã‚’é€ä¿¡</button>
        </aside>

        <main class="preview"><div id="svg-canvas"></div></main>

        <div id="color-popover" class="popover" onclick="event.stopPropagation()">
            <div id="color-grid" class="color-grid"></div>
        </div>
    </div>

    <script>
        const COLORS = [{n:"ãƒ–ãƒ©ãƒƒã‚¯",c:"#000000"},{n:"ãƒã‚¤ãƒ“ãƒ¼",c:"#000040"},{n:"Aãƒã‚¤ãƒ“ãƒ¼",c:"#001a4d"},{n:"Lãƒã‚¤ãƒ“ãƒ¼",c:"#1a3366"},{n:"Pãƒã‚¤ãƒ“ãƒ¼",c:"#333399"},{n:"ã‚´ãƒ¼ãƒ«ãƒ‰",c:"#c5a059"},{n:"Rãƒ–ãƒ«ãƒ¼",c:"#0047ab"},{n:"ãƒ–ãƒ«ãƒ¼",c:"#0055a4"},{n:"ã‚µãƒƒã‚¯ã‚¹",c:"#41b6e6"},{n:"Lã‚µãƒƒã‚¯ã‚¹",c:"#a5d7e8"},{n:"ã‚¿ãƒ¼ã‚³ã‚¤ã‚º",c:"#00a39b"},{n:"ãƒãƒªãƒ³ãƒ–ãƒ«ãƒ¼",c:"#00839b"},{n:"ãƒ©ã‚¤ãƒ ",c:"#b7d433"},{n:"ã‚·ãƒ«ãƒãƒ¼",c:"#c0c0c0"},{n:"Dã‚°ãƒ¬ãƒ¼",c:"#666666"},{n:"ã‚°ãƒ¬ãƒ¼",c:"#999999"},{n:"ã‚¤ã‚¨ãƒ­ãƒ¼",c:"#ffdc00"},{n:"Lã‚¤ã‚¨ãƒ­ãƒ¼",c:"#fff352"},{n:"ã‚¨ãƒ³ã‚¸",c:"#6d1719"},{n:"Dã‚°ãƒªãƒ¼ãƒ³",c:"#003324"},{n:"ã‚°ãƒªãƒ¼ãƒ³",c:"#00703c"},{n:"ã‚±ãƒªãƒ¼ã‚°ãƒªãƒ¼ãƒ³",c:"#009b48"},{n:"Dãƒ‘ãƒ¼ãƒ—ãƒ«",c:"#361f5b"},{n:"ãƒ‘ãƒ¼ãƒ—ãƒ«",c:"#5d2d91"},{n:"Lãƒ‘ãƒ¼ãƒ—ãƒ«",c:"#b19cd9"},{n:"Mãƒ‘ãƒ¼ãƒ—ãƒ«",c:"#8b008b"},{n:"ãƒ–ãƒ©ã‚¦ãƒ³",c:"#4e2a1e"},{n:"ã‚ªãƒ¬ãƒ³ã‚¸",c:"#f36f21"},{n:"Mã‚ªãƒ¬ãƒ³ã‚¸",c:"#ff8200"},{n:"Lã‚ªãƒ¬ãƒ³ã‚¸",c:"#ff9e1b"},{n:"ã‚¢ã‚¤ãƒœãƒªãƒ¼",c:"#f5f5dc"},{n:"Dãƒ¬ãƒƒãƒ‰",c:"#a50034"},{n:"ãƒ¬ãƒƒãƒ‰",c:"#e4002b"},{n:"ãƒ›ãƒƒãƒˆãƒ”ãƒ³ã‚¯",c:"#e4007f"},{n:"ãƒ”ãƒ³ã‚¯",c:"#f49ac2"},{n:"Lãƒ”ãƒ³ã‚¯",c:"#ffc0cb"},{n:"ã‚¤ã‚¨ãƒ­ãƒ¼G",c:"#ffcc00"},{n:"ãƒ›ãƒ¯ã‚¤ãƒˆ",c:"#ffffff"}];
        let curColors = { c0:{c:"#41b6e6",n:"ã‚µãƒƒã‚¯ã‚¹"}, c3:{c:"#b7d433",n:"ãƒ©ã‚¤ãƒ "}, c5:{c:"#e4002b",n:"ãƒ¬ãƒƒãƒ‰"}, nc:{c:"#000000",n:"ãƒ–ãƒ©ãƒƒã‚¯"} };
        let designLibrary = {}, activePart = null, currentSport = "", isAdmin = <?= isAdmin ?>;

        window.onload = () => {
            initColorPicker();
            updateSwatches();
            if(isAdmin) document.getElementById('admin_indicator').style.display = 'block';
        };

        function initColorPicker() {
            const grid = document.getElementById('color-grid');
            COLORS.forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'chip'; chip.style.backgroundColor = item.c;
                chip.onclick = () => selectColor(item.c, item.n);
                grid.appendChild(chip);
            });
        }

        function togglePop(p) { activePart = p; document.getElementById('color-popover').style.display = 'block'; }
        function hideAllPops() { document.getElementById('color-popover').style.display = 'none'; }
        function selectColor(c, n) { curColors[activePart] = {c:c, n:n}; updateSwatches(); apply(); hideAllPops(); }

        function updateSwatches() {
            for(let id in curColors) {
                document.getElementById("sw_"+id).style.backgroundColor = curColors[id].c;
                document.getElementById("txt_"+id).textContent = curColors[id].n;
            }
        }

        function openCatalog(s) {
            currentSport = s;
            document.getElementById('start-screen').style.display = 'none';
            google.script.run.withSuccessHandler(lib => {
                designLibrary = lib; const grid = document.getElementById('gallery-grid'); grid.innerHTML = '';
                const sel = document.getElementById('design_select'); sel.innerHTML = '';
                for(let name in lib) {
                    let card = document.createElement('div'); card.className = 'sport-card'; card.onclick = () => startSim(name);
                    card.innerHTML = `<div style="height:100px;">${lib[name].variants[0].svg}</div><p>${name}</p>`;
                    grid.appendChild(card);
                    let opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
                }
                document.getElementById('catalog-screen').style.display = 'flex';
            }).getDesignLibraryBySport(s);
        }

        function startSim(n) { document.getElementById('design_select').value = n; document.getElementById('catalog-screen').style.display='none'; document.getElementById('main-app').style.display='flex'; updateCollarOptions(); }
        function goBackToStart() { document.getElementById('catalog-screen').style.display='none'; document.getElementById('start-screen').style.display='flex'; }
        function goBackToCatalog() { document.getElementById('main-app').style.display='none'; document.getElementById('catalog-screen').style.display='flex'; }

        function updateCollarOptions() {
            const n = document.getElementById('design_select').value;
            const sel = document.getElementById('collar_select'); sel.innerHTML = '';
            designLibrary[n].variants.forEach((v, i) => {
                let opt = document.createElement('option'); opt.value = i; opt.textContent = v.collar; sel.appendChild(opt);
            });
            loadVariant();
        }

        function loadVariant() {
            const n = document.getElementById('design_select').value;
            const i = document.getElementById('collar_select').value;
            document.getElementById('svg-canvas').innerHTML = designLibrary[n].variants[i].svg;
            apply();
        }

        function apply() {
            const svg = document.querySelector('#svg-canvas svg');
            if(!svg) return;
            svg.style.setProperty('--c0', curColors.c0.c);
            svg.style.setProperty('--c3', curColors.c3.c);
            svg.style.setProperty('--c5', curColors.c5.c);
            svg.style.setProperty('--nc', curColors.nc.c);
            
            if(!svg.getElementById('svg_num')) {
                svg.insertAdjacentHTML('beforeend', `<g style="pointer-events:none;"><text id="svg_num" x="338" y="150" text-anchor="middle" font-family="Impact" font-size="100"></text><text id="svg_name" x="338" y="100" text-anchor="middle" font-family="Impact" font-size="40"></text></g>`);
            }
            svg.getElementById('svg_num').textContent = document.getElementById('v_num').value || "10";
            svg.getElementById('svg_num').setAttribute('fill', curColors.nc.c);
            svg.getElementById('svg_name').textContent = (document.getElementById('v_name').value || "TASTO").toUpperCase();
            svg.getElementById('svg_name').setAttribute('fill', curColors.nc.c);
        }

        function enableAdminMode() { location.href = location.href.split('?')[0] + '?admin=true'; }

        function saveOrder() {
            const n = document.getElementById('design_select').value;
            const i = document.getElementById('collar_select').value;
            const v = designLibrary[n].variants[i];
            const data = {
                designId: v.id, designName: n, sportType: currentSport, collarType: v.collar,
                number: document.getElementById('v_num').value, nameText: document.getElementById('v_name').value,
                colorBody: curColors.c0.n, colorSleeve: curColors.c3.n, colorCollar: curColors.c5.n, colorNum: curColors.nc.n
            };
            google.script.run.withSuccessHandler(() => alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼")).saveOrder(data);
        }
    </script>
</body>
</html>